FROM mambaorg/micromamba

ENV VERSION=105.0

USER root
RUN apt-get update && \
	apt-get install git -y && \
  apt-get clean
USER mambauser

SHELL ["micromamba", "run", "-n", "base", "/bin/bash", "-c"]

RUN micromamba install -y -c conda-forge -c bioconda -c defaults ensembl-vep==$VERSION

RUN micromamba install -y --prefix $MAMBA_ROOT_PREFIX -c bioconda -c conda-forge perl-bio-bigfile perl-dbd-sqlite perl-list-moreutils samtools

RUN git clone -b grch38 https://github.com/konradjk/loftee.git

ENV VEP_SHARE=$MAMBA_ROOT_PREFIX/share/ensembl-vep-$VERSION-*

RUN rm $VEP_SHARE/TissueExpression.pm $VEP_SHARE/ancestral.pm $VEP_SHARE/context.pm $VEP_SHARE/de_novo_donor.pl $VEP_SHARE/extended_splice.pl $VEP_SHARE/gerp_dist.pl $VEP_SHARE/loftee_splice_utils.pl $VEP_SHARE/splice_site_scan.pl $VEP_SHARE/svm.pl $VEP_SHARE/utr_splice.pl 

RUN cp -r loftee/* $VEP_SHARE && \
  rm -rf loftee 

USER root
RUN echo "export PERL5LIB=/:$MAMBA_ROOT_PREFIX/share/ensembl-vep/" >> /etc/bash.bashrc && \
  echo "export LOFTEE_PLUGIN_PATH=$MAMBA_ROOT_PREFIX/share/ensembl-vep/" >> /etc/bash.bashrc
USER mambauser

RUN vep_install --AUTO a --NO_UPDATE --NO_HTSLIB --DESTDIR $MAMBA_ROOT_PREFIX/share/ensembl-vep-$VERSION* && ln -fs $MAMBA_ROOT_PREFIX/share/ensembl-vep-$VERSION* $MAMBA_ROOT_PREFIX/share/ensembl-vep

CMD ["bash"]
